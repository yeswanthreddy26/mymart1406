<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>User Orders</title>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom CSS for styling -->
    <style>
        /* Custom styles for the user orders page */
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }

        .order-card {
            margin-bottom: 20px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        .order-item {
            border-bottom: 1px solid #ddd;
            padding: 10px 0;
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .total-amount {
            font-weight: bold;
        }

        .product-image {
            max-height: 140px;
            max-width: 140px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="mt-4 mb-4">My Orders</h1>

        <div th:each="order : ${userOrders}" class="order-card">
            <h5 th:text="'Order Number: ' + ${order.orderNumber}" class="mb-3"></h5>
            <p th:text="'Order Date: ' + ${order.orderDate}" class="mb-2"></p>

            <div class="table-responsive">
                <table class="table order-item-table">
                    <thead>
                        <tr>
                            <th>Product Image</th>
                            <th>Product Name</th>
                            <th>Quantity</th>
                            <th>Price</th>
                            <th>Total Price</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="orderItem : ${order.orderItems}" class="order-item">
                            <td>
                                <a th:href="@{cart/viewproduct(id=${orderItem.product.id})}">
                                    <img th:src="@{'/images/' + ${orderItem.product.imageFileName}}" class="img-fluid product-image" alt="Product Image">
                                </a>
                            </td>
                            <td th:text="${orderItem.product.name}"></td>
                            <td th:text="${orderItem.quantity}"></td>
                            <td th:text="${orderItem.product.price}"></td>
                            <td th:text="${orderItem.totalPrice}"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="row mt-3">
                <div class="col-md-6">
                    <p class="mb-1">Shipping Charges: <span th:text="${order.shippingCharges}"></span></p>
                    <p class="mb-0">Subtotal: <span th:text="${order.subtotal}"></span></p>
                </div>
                <div class="col-md-6 text-right">
                    <h4 class="total-amount mb-0">Total Amount: <span th:text="${order.totalAmount}"></span></h4>
                </div>
            </div>

            <!-- Additional elements inspired by Flipkart -->
            <div class="row mt-3">
                <div class="col-sm-6">
				    <a th:href="@{/trackOrder/{orderNumber}(orderNumber=${order.orderNumber})}" class="btn btn-primary">Track Order</a>
				</div>

                <div class="col-sm-6 text-right">
                    <a href="#" class="btn btn-outline-primary">Write a Review</a>
                </div>
            </div>

            <!-- Button to Generate Invoice -->
            <div class="row mt-3">
                <div class="col-sm-12 text-right">
                    <button onclick="generateInvoice(this)" class="btn btn-success">Generate Invoice</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS (optional if needed) -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- jsPDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        async function generateInvoice(button) {
            const { jsPDF } = window.jspdf;

            const orderCard = button.closest('.order-card');
            const orderNumber = orderCard.querySelector('h5').innerText.split('Order Number: ')[1];
            const orderDate = orderCard.querySelector('p').innerText.split('Order Date: ')[1];
            const orderItems = orderCard.querySelectorAll('.order-item');
            const shippingCharges = orderCard.querySelector('.mb-1 span').innerText;
            const subtotal = orderCard.querySelector('.mb-0 span').innerText;
            const totalAmount = orderCard.querySelector('.total-amount span').innerText;

            // Set page size to A2
            const doc = new jsPDF('p', 'mm', 'a2');
            doc.setFont('Helvetica');

            let y = 40;

            // Add MyMart title
            doc.setFontSize(50);
            doc.text('MyMart', 210, y, { align: 'center' });
            y += 40;

            // Add Invoice title
            doc.setFontSize(40);
            doc.text('Invoice', 210, y, { align: 'center' });
            y += 30;

            // Add order details
            doc.setFontSize(26);
            doc.text(`Order Number: ${orderNumber}`, 20, y);
            y += 20;
            doc.text(`Order Date: ${orderDate}`, 20, y);
            y += 30;

            // Add table headers
            doc.setFontSize(24);
            doc.text('Product Image', 20, y);
            doc.text('Product Name', 80, y);
            doc.text('Quantity', 220, y);
            doc.text('Price', 260, y);
            doc.text('Total Price', 300, y);
            y += 10;
            doc.setLineWidth(0.5);
            doc.line(20, y, 400, y); // Horizontal line
            y += 10;

            // Add table rows
            for (const [index, item] of orderItems.entries()) {
                const productImage = item.querySelector('td:nth-child(1) img').src;
                const productName = item.querySelector('td:nth-child(2)').innerText;
                const quantity = item.querySelector('td:nth-child(3)').innerText;
                const price = item.querySelector('td:nth-child(4)').innerText;
                const totalPrice = item.querySelector('td:nth-child(5)').innerText;

                // Add product image
                const image = await fetch(productImage)
                    .then(res => res.blob())
                    .then(blob => {
                        return new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onloadend = () => resolve(reader.result);
                            reader.readAsDataURL(blob);
                        });
                    });

                doc.addImage(image, 'JPEG', 20, y, 40, 40);

                doc.text(productName, 80, y + 20);
                doc.text(quantity, 220, y + 20);
                doc.text(price, 260, y + 20);
                doc.text(totalPrice, 300, y + 20);
                y += 50;
            }

            y += 10;
            doc.text(`Shipping Charges: ${shippingCharges}`, 20, y);
            y += 20;
            doc.text(`Subtotal: ${subtotal}`, 20, y);
            y += 20;
            doc.text(`Total Amount: ${totalAmount}`, 20, y);

            doc.save('invoice.pdf');
        }
    </script>
</body>

</html>
